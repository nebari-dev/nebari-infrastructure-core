apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-realm-setup
  namespace: keycloak
  labels:
    app.kubernetes.io/part-of: nebari-foundational
    app.kubernetes.io/managed-by: nebari-infrastructure-core
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: realm-setup
          image: quay.io/keycloak/keycloak:24.0
          env:
            - name: KEYCLOAK_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .KeycloakAdminSecretName }}
                  key: admin-password
            - name: REALM_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nebari-realm-admin-credentials
                  key: password
            - name: KEYCLOAK_URL
              value: {{ .KeycloakServiceURL }}/auth
          command:
            - /bin/bash
            - -c
            - |
              set -e
              KCADM="/opt/keycloak/bin/kcadm.sh"

              echo "Waiting for Keycloak to be ready..."
              for i in $(seq 1 60); do
                if $KCADM config credentials --server "$KEYCLOAK_URL" --realm master --user admin --password "$KEYCLOAK_ADMIN_PASSWORD" 2>/dev/null; then
                  echo "Keycloak is ready"
                  break
                fi
                echo "Keycloak not ready, waiting... ($i/60)"
                sleep 5
              done

              echo "Creating nebari realm..."
              $KCADM create realms \
                -s realm=nebari \
                -s enabled=true \
                -s displayName="Nebari" \
                -s sslRequired=external \
                -s registrationAllowed=false \
                -s loginWithEmailAllowed=true \
                -s resetPasswordAllowed=true \
                -s bruteForceProtected=true || echo "Realm may already exist"

              echo "Creating realm roles..."
              $KCADM create roles -r nebari -s name=admin -s description="Administrator role" || true
              $KCADM create roles -r nebari -s name=user -s description="Regular user role" || true

              echo "Creating admin user in nebari realm..."
              $KCADM create users -r nebari \
                -s username=admin \
                -s enabled=true \
                -s emailVerified=true \
                -s firstName=Admin \
                -s lastName=User \
                -s email=admin@nebari.local || echo "User may already exist"

              echo "Setting admin user password..."
              $KCADM set-password -r nebari \
                --username admin \
                --new-password "$REALM_ADMIN_PASSWORD"

              echo "Assigning roles to admin user..."
              $KCADM add-roles -r nebari --uusername admin --rolename admin || true
              $KCADM add-roles -r nebari --uusername admin --rolename user || true

              echo "Realm setup complete!"
