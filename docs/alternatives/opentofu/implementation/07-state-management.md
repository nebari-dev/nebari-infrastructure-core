# State Management with Terraform State

### 7.1 Terraform State Backends

**No Custom State Format Needed:**
- Use Terraform's built-in state backends
- Standard locking mechanisms
- Existing tooling works (terraform state commands, Atlantis, Terraform Cloud)

**Backend Configuration (Generated by NIC):**

**AWS (S3 + DynamoDB):**
```hcl
terraform {
  backend "s3" {
    bucket         = "nebari-prod-terraform-state"
    key            = "nic/terraform.tfstate"
    region         = "us-west-2"
    encrypt        = true
    dynamodb_table = "nebari-prod-terraform-locks"
  }
}
```

**GCP (Cloud Storage):**
```hcl
terraform {
  backend "gcs" {
    bucket = "nebari-prod-terraform-state"
    prefix = "nic"
  }
}
```

**Azure (Blob Storage):**
```hcl
terraform {
  backend "azurerm" {
    storage_account_name = "nebaristate"
    container_name       = "tfstate"
    key                  = "nic/terraform.tfstate"
  }
}
```

**Local:**
```hcl
terraform {
  backend "local" {
    path = "terraform.tfstate"
  }
}
```

### 7.2 State Locking

**Automatic via Terraform:**
- **AWS**: DynamoDB table for locking
- **GCP**: Cloud Storage object generation metadata
- **Azure**: Blob lease mechanism
- **Local**: File locking

**No Custom Lock Implementation Needed** - Terraform handles it.

### 7.3 Drift Detection

**Using terraform plan:**
```go
func (p *TofuProvider) DetectDrift(ctx context.Context) (*DriftReport, error) {
    ctx, span := tracer.Start(ctx, "TofuProvider.DetectDrift")
    defer span.End()

    slog.InfoContext(ctx, "detecting infrastructure drift")

    // Run terraform plan with detailed output
    hasChanges, err := p.executor.Plan(ctx, []string{"terraform.tfvars"})
    if err != nil {
        return nil, fmt.Errorf("running terraform plan: %w", err)
    }

    if !hasChanges {
        slog.InfoContext(ctx, "no drift detected")
        return &DriftReport{DriftsDetected: 0}, nil
    }

    // Parse plan output to identify drifts
    // (terraform-exec provides structured plan output)

    slog.WarnContext(ctx, "infrastructure drift detected")

    return &DriftReport{
        DriftsDetected: len(drifts),
        Drifts:         drifts,
    }, nil
}
```

### 7.4 State Operations

**Terraform provides built-in commands:**

```bash
# List resources in state
terraform state list

# Show specific resource
terraform state show aws_eks_cluster.main

# Move resource in state
terraform state mv aws_eks_cluster.old aws_eks_cluster.new

# Remove resource from state (without destroying)
terraform state rm aws_eks_cluster.main

# Pull state to local file
terraform state pull > backup.tfstate

# Push state from local file
terraform state push backup.tfstate
```

**NIC can expose these via CLI:**
```bash
# NIC wrappers
nic state list
nic state show <resource>
nic state backup
nic state restore <file>
```

### 7.5 State Migration and Versioning

**Terraform handles state versioning automatically:**
- State file includes `terraform_version` and `serial` number
- Automatic upgrades when using newer Terraform versions
- Built-in state migration support

**NIC just needs to ensure:**
- Compatible Terraform/OpenTofu version
- Proper backend configuration
- State backup before major operations

---
